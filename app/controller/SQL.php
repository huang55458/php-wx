<?php

declare (strict_types=1);

namespace app\controller;

use think\facade\Db;
use think\Request;

class SQL
{
    public function create_sql($table, $arr)
    {
        foreach ($arr as $k => $v) {
            if ($k === 'id') {
                continue;
            }

            $f[] = '`' . $k . '`';
            if (is_int($v)) {
                $val[] = $v;
            } elseif (is_null($v)) {
                $val[] = 'null';
            } else {
                $v = str_replace("'", "\'", $v);
                $val[] = "'" . $v . "'";
            }

        }
        $f = implode(',', $f);
        $val = implode(',', $val);
        return "insert into " . $table . "(" . $f . ") values (" . $val . ");";
    }

    /**
     * 显示资源列表
     *
     * @return \think\Response
     */
    public function index()
    {
        $file_path = runtime_path() . DIRECTORY_SEPARATOR . 'tmp.sql';
        $data = file_get_contents('C:\Users\Administrator\Documents\demo.json');
        $data = json_decode($data, true)['RECORDS'];
        foreach ($data as $v) {
            $v['group_id'] = 2024;
            $v['company_id'] = 61954;
            $v['pz_id'] = 3621;
            //            $v['group_id'] = 1000;
            //            $v['company_id'] = 2;
            //            $v['pz_id'] = 2621;
            $v['create_by'] = 61954;
            $v['update_by'] = 61954;
            $v['create_by_uid'] = 128863;
            $v['update_by_uid'] = 128863;
            $v['create_time'] = date('Y-m-d H:i:s');
            $v['update_time'] = date('Y-m-d H:i:s');
            $sql = $this->create_sql(' `cmm_pro`.`p_zone_detail` ', $v);
            file_put_contents($file_path, $sql . PHP_EOL, FILE_APPEND);
        }
        return json('success');
    }

    /**
     * 显示创建资源表单页.
     *
     * @return \think\Response
     */
    public function create()
    {
        $data = [
            'id' => 1,
            'ext' => "'ffffff"
        ];
        return $this->create_sql('od', $data);
    }

    /**
     * 运单更换开票主体
     */
    public function save()
    {
        $ids = [179875620,179875600,179875583,179875565,179875547,179875529,179875507,179875478,179875443,179875425,179875410,179875398,179875383,179875372,179875352,179875338,179875321,179875308,179875293,179875265,179875245,179875225,179853992,179816854,179816817,179816775,179816747,179816715,179816684,179816656,179816615,179816586,179816553,179816536,179763151,179763118,179763077,179763030,179762997,179762963,179762922,179762885,179762720,179762510,179762447,179609929,179555877,179555842,179555824,179555803,179555778,179555763,179555734,179555711,179555680,179555658,179555639,179555617,179555587,179481452,179481394,179481349,179481214,179481110,179481057,179480902,179480845,179480793,179480737,179480695,179480649,179446391,179445365,179445342,179445274,179445254,179445223,179445160,179444990,179444965,179444934,179444915,179444893,179444872,179444844,179396743,179396636,179396568,179396516,179396440,179396414,179396379,179396346,179396313,179396282,179241763,179186156,179186139,179186117,179186103,179186089,179186071,179186054,179186038,179186030,179186015,179186003,179185990,179185983,179104932,179104881,179104837,179104780,179104734,179104701,179104651,179104612,179104570,179104509,179104462,179104414,179067565,179067540,179067519,179067491,179067470,179067438,179067423,179067395,179067370,179067336,179067301,179067277,179067252,179010259,179010220,179010186,179010141,179010106,179010046,179009976,179009941,179009888,179009853,179009794,179001776,178863187,178809220,178809192,178809163,178809137,178809105,178809060,178809018,178808991,178808969,178808855,178808824,178808797,178756148,178756135,178756113,178756103,178756084,178756061,178756051,178756037,178756020,178756005,178755985,178755963,178755951,178695142,178695125,178695098,178695080,178695059,178695025,178695007,178694981,178694951,178694916,178694885,178694845,178694811,178638271,178638224,178638152,178637043,178636995,178636943,178636899,178636844,178636793,178636740,178616896,178541938,178541894,178541862,178541821,178482680,178482542,178482515,178427336,178427317,178427299,178427277,178427253,178427237,178427218,178427201,178427177,178427163,178427149,178427133,178427107,178370156,178370141,178370117,178370102,178370081,178370059,178370035,178370023,178370006,178369979,178369921,178369908,178302224,178302145,178302091,178302001,178301925,178301883,178301838,178301794,178301702,178301646,178301593,178301527,178301449,178300909,178252600,178252227,178252122,178252077,178251981,178251940,178251855,178251801,178251762,178095657,178019738,178019691,178019645,178019597,178019552,178019476,178019438,178019383,178019347,178019306,178019251,177984939,177984891,177984854,177984806,177984760,177984712,177984670,177984620,177984587,177984539,177984486,177984434,177984366,177984323,177918898,177918819,177918752,177918683,177918634,177918563,177918510,177918452,177918386,177918325,177877378,177877359,177877330,177877300,177877272,177877245,177749099,177635497,177635353,177635202,177635164,177635119,177635066,177635015,177634966,177634926,177634879,177634797,177634736,177634678,177634619,177634559,177634486,177634433,177580351,177580303,177580254,177580170,177580097,177580034,177579981,177579937,177579899,177515770,177515733,177515691,177515656,177515614,177515551,177515504,177515466,177515420,177515361,177515323,177515267,177490344,177490314,177490293,177490273,177490258,177490233,177490070,177490010,177489986,177489961,177470859,177380962,177329698,177329664,177276382,177276188,177276167,177276147,177276114,177276072,177276052,177276020,177276001,177275989,177275971,177275953,177275916,177275896,177275871,177275853,177275791,177275766,177275532,177275500,177275478,177275452,177198267,177198227,177198159,177198097,177198026,177197965,177197903,177197866,177197797,177197736,177197641,177152839,177152753,177152700,177152645,177106038,177106015,177105986,177105964,177105945,177105894,177105876,177105854,176919765,176919698,176919637,176919565,176919499,176919445,176919395,176919318,176856200,176856137,176856075,176856011,176855944,176855895,176855831,176855782,176855715,176855656,176784540,176784480,176784399,176784315,176784266,176784222,176784189,176784127,176784085,176784038,176742098,176742050,176742011,176741949,176691681,176691651,176691591,176691552,176691511,176691487,176691453,176691385,176691333,176617453,176617407,176616577,176582655,176564315,176563984,176563960,176563934,176563852,176563832,176563806,176563782,176563751,176563729,176563696,176563646,176563623,176563602,176563578,176563551,176510974,176510923,176510868,176510839,176510800,176510766,176455056,176454982,176454894,176454815,176454742,176454622,176454559,176454503,176209915,176209838,176209791,176209750,176209688,176209645,176209604,176209556,176209489,176209441,176208969,176208867,176208795,176208715,176208657,176208609,176208559,176208510,176208448,176072020,176071994,176071959,176071910,176071864,176071831,176071784,176071750,176071716,176071677,176071633,176071604,176071566,176037659,176037615,176037547,176037494,175990250,175990200,175990148,175990098,175990044,175989956,175989887,175989815,175989738,175975577,175820110,175762853,175762817,175762769,175762724,175762666,175762568,175762517,175762423,175762385,175762330,175762291,175762244,175762174,175762110,175762055,175761991,175761906,175761838,175761742,175761690,175759361,175759288,175759251,175759209,175759167,175759145,175759099,175759068,175726798,175726783,175726764,175726740,175726729,175726712,175726697,175726677,175726649,175718083,175718071,175718055,175692634,175692611,175692573,175692543,175692463,175692427,175692381,175444700,175444673,175444644,175444607,175444593,175444581,175444567,175444542,175444521,175444507,175444486,175444462,175444442,175444418,175444397,175444375,175444355,175444334,175444317,175345856,175345822,175345789,175345761,175345737,175345717,175345699,175345672,175345663,175345637,175345613,175345596,175317804,175317706,175317611,175317219,175316953,175316911,175278469,175278453,175278423,175278407,175278395,175278373,175278349,175278322,175277330,175277299,175092515,175092426,175055639,175055626,175055616,175055605,175055591,175055561,175055554,175055538,175055528,175055513,175055498,175055488,175055424,175055412,175055402,174964198,174964162,174964120,174964063,174964029,174963983,174963941,174963900,174963870,174963838,174963803,174963773,174963735,174963633,174963598,174963567,174963535,174963492,174963470,174963343,174928928,174928891,174928841,174928754,174928705,174877755,174877712,174877661,174877622,174877574,174877513,174877476,174877426,174662375,174662275,174662221,174662165,174662089,174662028,174661958,174661893,174661806,174661759,174661692,174661609,174661552,174661509,174661467,174661422,174661333,174661227,174661168,174661117,174609661,174609619,174609589,174609531,174609428,174609388,174609351,174609307,174609271,174609243,174609210,174609178,174609143,174609099,174540180,174540118,174540068,174540005,174539729,174504154,174504136,174504126,174504108,174504085,174504061,174503809,174482272,174263961,174202310,174202258,174202207,174202147,174202106,174202068,174201983,174201905,174201866,174201812,174201780,174201737,174201705,174201656,174201621,174201578,174201528,174135908,174135859,174135823,174135758,174135704,174135652,174135621,174135581,174135516,174135484,174135434,174135377,174092058,174092013,174091965,174091922,174091887,174059235,174059228,174059219,174059212,174059200,174059188,174059179,174059166,174059155,174059148,173904314,173846530,173846495,173846450,173846394,173846349,173846289,173846197,173846145,173846094,173846025,173845962,173845900,173845848,173845777,173792031,173791971,173791922,173791783,173791702,173791620,173789961,173789840,173789794,173789697,173789632,173789580,173789517,173789477,173789405,173789374,173789319,173744108,173744076,173744054,173744032,173744003,173699241,173699229,173699214,173699197,173699184,173699176,173699169,173699153,173699147,173699119,173699108,173544803,173544764,173487744,173487712,173487684,173487644,173487607,173487494,173487427,173487386,173487357,173487312,173487265,173487233,173487188,173487142,173487104,173487043,173487005,173486772,173486727,173486679,173439158,173439140,173439125,173439106,173439084,173439070,173439055,173439037,173439016,173438999,173438974,173438960,173379660,173379628,173379585,173379548,173332906,173332861,173332827,173332794,173332768,173332754,173332731,173332704,173332674,173311705,173192858,173192825,173168867,173168845,173168824,173168799,173168771,173168749,173168721,173168693,173168661,173168633,173168602];
        foreach ($ids as $od_id) {
            $o_d = Db::connect('pro_order')->table('od')
                ->field('id,od_ext_info')
                ->whereRaw("id = $od_id")
                ->fetchSql(false)->select()->toArray();
            $od_ext_info = $o_d[0]['od_ext_info'];
            $roll_sql = "UPDATE `cmm_pro`.`od` SET `od_ext_info` = '$od_ext_info' WHERE `id` = $od_id;";
            file_put_contents(runtime_path() . DIRECTORY_SEPARATOR . 'tmp.sql', $roll_sql . PHP_EOL, FILE_APPEND);
            $od_ext_info_decode = decode_json($o_d[0]['od_ext_info']);
            $od_ext_info_decode['invoicing_ids'] = array_diff($od_ext_info_decode['invoicing_ids'], [28]);
            $od_ext_info_decode['invoicing_ids'][] = 58;
            $od_ext_info_encode = encode_json($od_ext_info_decode);
            $update_sql = "UPDATE `cmm_pro`.`od` SET `od_ext_info` = '$od_ext_info_encode' WHERE `id` = $od_id;";
            file_put_contents(runtime_path() . DIRECTORY_SEPARATOR . 'tmp2.sql', $update_sql . PHP_EOL, FILE_APPEND);
        }
        dump('success');
    }

    /**
     * 运单关联开票
     *
     */
    public function read()
    {
        $data = [
            [
                "od_link_id" => "442037090",
                "od_basic_id" => "284527201"
            ]
        ];
//        dd(implode(',', array_map('intval', array_column($data,'od_basic_id'))));
        foreach ($data as $v) {
            $id = $v['od_basic_id'];
            $o_d = Db::connect('pro_order')->table('od_basic')
                ->field('ob_ext')
                ->whereRaw("id = $id")
                ->fetchSql(false)->select()->toArray();
            $ob_ext = $o_d[0]['ob_ext'];
            $roll_sql = "UPDATE `cmm_pro`.`od_basic` SET `ob_ext` = '$ob_ext' WHERE `id` = $id;";
            file_put_contents(runtime_path() . DIRECTORY_SEPARATOR . 'tmp.sql', $roll_sql . PHP_EOL, FILE_APPEND);
            $ob_ext_decode = decode_json($o_d[0]['ob_ext']);
            $ob_ext_decode['invoicing_info'][$v['od_link_id']]['apply_invoicing_id'] = 25001;
            $ob_ext_encode = encode_json($ob_ext_decode);
            $update_sql = "UPDATE `cmm_pro`.`od_basic` SET `ob_ext` = '$ob_ext_encode' WHERE `id` = $id;";
            file_put_contents(runtime_path() . DIRECTORY_SEPARATOR . 'tmp2.sql', $update_sql . PHP_EOL, FILE_APPEND);
        }
        dump('success');
    }

    /**
     * 显示编辑资源表单页.
     *
     * @param int $id
     * @return \think\Response
     */
    public function edit($id)
    {
        //
    }

    /**
     * 保存更新的资源
     *
     * @param \think\Request $request
     * @param int $id
     * @return \think\Response
     */
    public function update(Request $request, $id)
    {
        //
    }

    /**
     * 删除指定资源
     *
     * @param int $id
     * @return \think\Response
     */
    public function delete($id)
    {
        //
    }
}
